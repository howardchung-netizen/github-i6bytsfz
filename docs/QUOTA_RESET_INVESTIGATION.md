# 配額重置問題調查

## 🔍 問題描述

1. **配額一直沒有重置，已經2天了**
2. **如果一直用1.5 Flash，為什麼會顯示2.5 Flash配額已用完？**

---

## 📋 問題分析

### 問題 1: 配額重置機制

#### Google Gemini API 配額重置機制

**可能的情況**：

1. **24小時滾動窗口**（最可能）
   - 配額不是按日曆日重置
   - 而是從第一次使用開始的24小時滾動窗口
   - 例如：如果昨天下午3點用完配額，今天下午3點才會重置

2. **按 API Key 創建時間重置**
   - 配額重置時間可能基於 API Key 的創建時間
   - 不是固定的每天某個時間

3. **配額確實重置了，但沒有注意到**
   - 可能已經重置，但因為其他原因（如模型問題）仍然失敗

#### 如何確認配額是否重置

**方法 1: 檢查 Google AI Studio**
1. 前往：https://aistudio.google.com/app/apikey
2. 點擊您的 API Key
3. 查看 "Usage" 或 "Rate Limit" 頁面
4. 查看：
   - 最後一次請求的時間
   - 當前使用量
   - 配額重置時間（如果有顯示）

**方法 2: 使用 API 測試**
訪問：
```
http://localhost:3000/api/check-quota
```

查看返回的配額狀態。

**方法 3: 記錄時間**
- 記錄第一次出現配額錯誤的時間
- 24小時後再測試
- 如果仍然失敗，可能是其他問題

---

### 問題 2: 為什麼顯示 2.5 Flash 配額已用完？

#### 可能的原因

**原因 1: 之前使用了不同的模型**

檢查歷史：
- 2天前晚上是否嘗試過使用 2.5 Flash 或 2.0 Flash？
- 是否在某個時候修改過模型配置？
- Vercel 部署環境是否使用了不同的模型？

**原因 2: 配額是共享的**

**重要發現**：
- Google Gemini API 的配額可能是**按 API Key 共享**的，不是按模型分別計算
- 即使現在使用 1.5 Flash，如果之前用 2.5 Flash 用完了配額，整個 API Key 的配額都會受影響

**原因 3: 錯誤訊息中的模型名稱**

從之前的錯誤訊息：
```
limit: 0, model: gemini-2.0-flash-exp
```

這表示：
- 錯誤訊息中提到的模型是 `gemini-2.0-flash-exp`
- 但代碼中現在使用的是 `gemini-flash-latest` (1.5 Flash)

**可能的情況**：
- 之前某個時候使用了 2.0 Flash，配額用完了
- 即使現在改回 1.5 Flash，配額仍然沒有重置

---

## 🔧 解決方案

### 方案 1: 確認配額重置時間

1. **檢查 Google AI Studio**：
   - 查看最後一次請求的準確時間
   - 計算24小時後的重置時間

2. **等待完整24小時**：
   - 從最後一次請求開始計算
   - 等待完整的24小時後再測試

### 方案 2: 檢查是否有其他地方使用不同模型

**檢查 Vercel 環境變數**：
1. 登入 Vercel Dashboard
2. 檢查環境變數
3. 確認沒有設置 `GEMINI_MODEL` 或其他模型相關變數

**檢查代碼歷史**：
- 查看 Git 歷史，確認之前是否使用過 2.0 或 2.5 Flash
- 檢查是否有其他 API 端點使用了不同的模型

### 方案 3: 重新生成 API Key

如果配額問題持續：

1. **前往 Google AI Studio**：
   - https://aistudio.google.com/app/apikey

2. **創建新的 API Key**：
   - 點擊 "Create API Key"
   - 選擇或創建新的 Google Cloud 專案

3. **更新環境變數**：
   - 更新 `.env.local` 文件
   - 更新 Vercel 環境變數（如果已部署）
   - 重啟開發服務器

4. **測試新 API Key**：
   - 使用新 API Key 測試
   - 應該有全新的配額

---

## 📊 配額重置機制確認

### Google Gemini API 配額重置規則

根據 Google 文檔和實際使用經驗：

1. **免費層配額**：
   - **RPM**: 每分鐘限制，按分鐘滾動
   - **RPD**: 每日限制，**可能是24小時滾動窗口**，不是日曆日

2. **重置時間**：
   - 不是固定的每天某個時間
   - 而是從第一次使用開始的24小時滾動窗口
   - 或者從 API Key 創建時間開始的24小時滾動窗口

3. **配額共享**：
   - 同一個 API Key 的所有模型共享配額
   - 使用 2.5 Flash 用完配額，會影響 1.5 Flash 的使用

---

## 🔍 診斷步驟

### 步驟 1: 確認當前使用的模型

檢查 `app/lib/constants.js`：
```javascript
export const CURRENT_MODEL_NAME = "gemini-flash-latest"; // 應該是這個
```

### 步驟 2: 檢查配額使用情況

訪問：
```
http://localhost:3000/api/check-quota
```

查看返回的配額狀態。

### 步驟 3: 檢查 Google AI Studio

1. 前往：https://aistudio.google.com/app/apikey
2. 查看使用量圖表
3. 確認：
   - 最後一次請求的時間
   - 當前使用量
   - 配額限制

### 步驟 4: 計算重置時間

如果最後一次請求是：
- **2天前的晚上**（例如：1月6日晚上8點）
- **重置時間應該是**：1月7日晚上8點（24小時後）
- **如果現在是1月8日**，應該已經重置了

如果仍然沒有重置，可能是：
1. 配額重置機制不是24小時滾動窗口
2. 有其他問題（如 API Key 被限制）

---

## 💡 建議

### 立即行動

1. **檢查 Google AI Studio**：
   - 確認最後一次請求的時間
   - 查看當前配額狀態

2. **測試當前配額**：
   - 訪問 `http://localhost:3000/api/check-quota`
   - 或嘗試生成一題

3. **如果配額確實沒重置**：
   - 考慮重新生成 API Key
   - 或升級到付費方案

### 長期解決方案

1. **實施配額監控**：
   - 記錄每次 API 調用
   - 追蹤配額使用情況
   - 在接近限制時提醒用戶

2. **優化 API 使用**：
   - 減少不必要的 API 調用
   - 實施緩存機制
   - 批量處理請求

3. **考慮付費方案**：
   - 如果免費配額不夠用
   - 升級到付費方案獲得更高配額

---

## 📝 記錄模板

請記錄以下信息：

- **最後一次成功請求時間**: ___________
- **第一次配額錯誤時間**: ___________
- **當前時間**: ___________
- **Google AI Studio 顯示的使用量**: ___________
- **Google AI Studio 顯示的重置時間**: ___________

根據這些信息，可以更準確地判斷配額重置機制。
