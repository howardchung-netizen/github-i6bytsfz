# Google Gemini API 配額共享機制詳細說明

## 🔍 核心問題

**配額是帳號共同嗎？申請多少個 API Key 都共享配額嗎？**

**答案：是的！配額是基於 Google Cloud 項目（Project）共享的，不是基於單個 API Key。**

---

## 📊 配額共享機制

### 1. 配額管理層級

```
Google 帳號
  └── Google Cloud 項目（Project）
      └── 所有 API Key（共享配額）
          ├── API Key 1
          ├── API Key 2
          ├── API Key 3
          └── ...
```

### 2. 重要理解

#### ✅ 配額是項目級別的
- **同一個 Google Cloud 項目下的所有 API Key 共享配額**
- 無論您申請 1 個還是 10 個 API Key，總配額都是一樣的
- 所有 API Key 的使用量會累加計算

#### ✅ 配額是帳號級別的（項目層面）
- 如果您有多個 Google Cloud 項目，每個項目有獨立的配額
- 但通常免費層配額是基於 Google 帳號的總體限制

#### ❌ 配額不是 API Key 級別的
- **申請多個 API Key 不會增加總配額**
- 所有 API Key 的使用量會累加，共用同一個配額池

---

## 💡 實際例子

### 場景 1：同一個項目，多個 API Key

**情況**：
- 項目：`my-gemini-project`
- API Key 1：用於開發環境（`.env.local`）
- API Key 2：用於生產環境（Vercel）
- API Key 3：用於測試環境

**配額使用**：
```
免費層配額：RPD 1,500 次/天

API Key 1 使用：500 次
API Key 2 使用：800 次
API Key 3 使用：200 次
─────────────────────
總計：1,500 次（配額用完！）
```

**結果**：即使 API Key 1 只用了 500 次，但因為總計達到 1,500 次，所有 API Key 都會顯示配額已用完。

### 場景 2：不同項目，不同配額

**情況**：
- 項目 A：`project-a`（有免費層配額）
- 項目 B：`project-b`（有免費層配額）

**配額使用**：
```
項目 A：
- API Key A1：使用 1,500 次（配額用完）
- API Key A2：無法使用（共享配額已用完）

項目 B：
- API Key B1：可以使用（獨立配額）
- API Key B2：可以使用（共享項目 B 的配額）
```

**結果**：不同項目的配額是獨立的，但同一項目內的 API Key 共享配額。

---

## 🎯 配額共享的範圍

### 1. 同一個項目內的所有 API Key

**共享內容**：
- ✅ RPM（每分鐘請求數）：15 次/分鐘
- ✅ RPD（每天請求數）：1,500 次/天
- ✅ Token 配額（免費層）
- ✅ 所有模型的配額（1.5 Flash、2.0 Flash 等）

**不共享**：
- ❌ 不同項目的配額（獨立計算）

### 2. 所有模型共享配額

**重要**：同一個 API Key 的所有模型共享配額！

例如：
- 使用 `gemini-2.5-flash` 用完了配額
- 即使改回使用 `gemini-1.5-flash`，配額仍然是用完的狀態
- **配額不是按模型分別計算的**

---

## 🔧 如何增加配額？

### 方案 1：創建新項目（不推薦）

**原理**：
- 每個 Google Cloud 項目有獨立的免費層配額
- 創建新項目 = 獲得新的配額

**限制**：
- 需要不同的 Google 帳號或項目
- 管理複雜（多個項目、多個 API Key）
- 可能違反 Google 的使用條款（如果目的是繞過配額限制）

### 方案 2：升級到付費方案（推薦）

**原理**：
- 付費方案有更高的配額限制
- 按使用量付費，沒有硬性配額限制

**優點**：
- ✅ 更高的配額（通常無限制或非常高）
- ✅ 更好的性能和支持
- ✅ 符合使用條款

**步驟**：
1. 前往 Google Cloud Console
2. 設置帳單（添加付款方式）
3. 啟用付費方案
4. 獲得更高配額

### 方案 3：等待配額重置

**原理**：
- 免費層配額會定期重置（24小時滾動窗口）
- 重置後可以繼續使用

**限制**：
- 需要等待（最多 24 小時）
- 配額仍然有限（RPD 1,500 次/天）

---

## 📝 檢查配額使用情況

### 1. Google AI Studio

**訪問**：https://aistudio.google.com/app/apikey

**查看內容**：
- 當前配額使用情況
- 每個 API Key 的使用量
- 配額重置時間

### 2. Google Cloud Console

**訪問**：https://console.cloud.google.com/

**查看內容**：
- 項目級別的配額使用情況
- 所有 API Key 的總使用量
- 配額限制和重置時間

**路徑**：
```
API 和服務 → 配額 → 搜尋 "Gemini"
```

---

## ⚠️ 常見誤解

### 誤解 1：申請多個 API Key 可以增加配額

**錯誤**：❌ 申請 10 個 API Key = 10 倍配額

**正確**：✅ 所有 API Key 共享同一個配額池

### 誤解 2：不同 API Key 有獨立配額

**錯誤**：❌ API Key 1 有 1,500 次，API Key 2 也有 1,500 次

**正確**：✅ 兩個 API Key 共享 1,500 次配額

### 誤解 3：不同模型有獨立配額

**錯誤**：❌ 1.5 Flash 有 1,500 次，2.0 Flash 也有 1,500 次

**正確**：✅ 所有模型共享同一個配額池

---

## 💡 最佳實踐

### 1. 監控配額使用

**建議**：
- 記錄每次 API 調用
- 在接近限制時提醒
- 使用 Google Cloud Console 監控

### 2. 優化 API 使用

**建議**：
- 減少不必要的調用
- 實施緩存機制
- 批量處理請求

### 3. 合理分配 API Key

**建議**：
- 開發環境：使用一個 API Key
- 生產環境：使用另一個 API Key
- 但記住：它們共享配額！

### 4. 考慮付費方案

**建議**：
- 如果免費配額經常不夠用
- 升級到付費方案
- 獲得更高的配額和更好的支持

---

## 🆘 如果配額不夠用

### 短期解決方案

1. **等待配額重置**（24小時滾動窗口）
2. **優化使用**（減少不必要的調用）
3. **實施緩存**（避免重複請求）

### 長期解決方案

1. **升級到付費方案**（推薦）
2. **申請配額增加**（聯繫 Google 支持）
3. **優化應用架構**（減少 API 調用）

---

## 📚 相關文檔

- `docs/QUOTA_SHARING_EXPLANATION.md` - 配額共享機制說明
- `docs/QUOTA_RESET_INVESTIGATION.md` - 配額重置機制調查
- `docs/API_KEY_DIAGNOSIS_GUIDE.md` - API Key 診斷指南

---

## ✅ 總結

1. **配額是項目級別的**：同一個 Google Cloud 項目下的所有 API Key 共享配額
2. **申請多個 API Key 不會增加配額**：所有 API Key 的使用量會累加
3. **所有模型共享配額**：1.5 Flash、2.0 Flash 等共享同一個配額池
4. **增加配額的方法**：升級到付費方案（推薦）或創建新項目（不推薦）

**關鍵要點**：配額是基於 Google Cloud 項目管理的，不是基於單個 API Key。申請多個 API Key 只是為了方便管理不同環境，但不會增加總配額。
