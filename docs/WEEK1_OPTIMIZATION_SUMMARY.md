# ç¬¬ 1 é€±å„ªåŒ–å¯¦æ–½ç¸½çµ

> **å¯¦æ–½æ—¥æœŸ**ï¼š2026-01-08  
> **ç›®æ¨™**ï¼šç‚º 1 è¬ç”¨æˆ¶è¦æ¨¡å„ªåŒ–æŸ¥è©¢æ€§èƒ½  
> **åˆ†é¡é‚è¼¯**ï¼šå¹´ç´š > ç§‘ç›® > å–®å…ƒ > å­å–®å…ƒ

---

## âœ… å·²å®Œæˆä»»å‹™

### 1. æ·»åŠ  `subject` æ¬„ä½åˆ°å„²å­˜é‚è¼¯

**æ–‡ä»¶**ï¼š`app/lib/rag-service.js`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… ä¿®æ”¹ `saveGeneratedQuestion` å‡½æ•¸ç°½åï¼Œæ·»åŠ  `subject` å’Œ `allTopicsList` åƒæ•¸
- âœ… å¯¦ç¾è‡ªå‹•æ¨æ–·é‚è¼¯ï¼šå¾ `topicId` æ¨æ–· `subject`ï¼ˆå¦‚æœæœªæä¾›ï¼‰
- âœ… æ·»åŠ å‘å¾Œå…¼å®¹ï¼šå¦‚æœç„¡æ³•æ¨æ–·ï¼Œé»˜èªç‚º `'math'`
- âœ… æ·»åŠ è©³ç´°æ—¥èªŒè¨˜éŒ„

**ä»£ç¢¼ä½ç½®**ï¼šç¬¬ 73-120 è¡Œ

---

### 2. æ›´æ–°æ‰€æœ‰èª¿ç”¨è™•å‚³å…¥ `subject`

**æ–‡ä»¶**ï¼š`app/lib/ai-service.js`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… æ›´æ–°ç·©å­˜é¡Œç›®å„²å­˜èª¿ç”¨ï¼ˆç¬¬ 88-100 è¡Œï¼‰
- âœ… æ›´æ–°ç¬¬ä¸€é¡Œå„²å­˜èª¿ç”¨ï¼ˆç¬¬ 416-424 è¡Œï¼‰
- âœ… æ›´æ–°å‰©é¤˜é¡Œç›®ç•°æ­¥å„²å­˜èª¿ç”¨ï¼ˆç¬¬ 431 è¡Œï¼‰
- âœ… æ‰€æœ‰èª¿ç”¨éƒ½å‚³å…¥ `targetSubject` å’Œ `allTopicsList`

**é—œéµæ”¹é€²**ï¼š
- å¾ `targetSubject` è®Šæ•¸ç²å–ç§‘ç›®ï¼ˆå·²åœ¨å‡½æ•¸ä¸­è¨ˆç®—ï¼‰
- å‚³å…¥ `allTopicsList` ä»¥ä¾¿æ¨æ–·ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

### 3. å¯¦æ–½æœå‹™å™¨ç«¯éæ¿¾

**æ–‡ä»¶**ï¼š`app/lib/rag-service.js`

**ä¿®æ”¹å…§å®¹**ï¼š
- âœ… ä¿®æ”¹ `fetchUnusedQuestion` æŸ¥è©¢é‚è¼¯
- âœ… æ·»åŠ æœå‹™å™¨ç«¯ `where` æ¢ä»¶ï¼š
  - `where("grade", "==", level)` - å¹´ç´šéæ¿¾
  - `where("subject", "==", subject)` - ç§‘ç›®éæ¿¾ï¼ˆå¦‚æœæä¾›ï¼‰
  - `where("topic_id", "==", topicId)` - å–®å…ƒéæ¿¾ï¼ˆå¦‚æœæä¾›ï¼‰
  - `where("source", "==", "ai_next_api")` - ä¾†æºéæ¿¾
- âœ… ä¿ç•™å®¢æˆ¶ç«¯éæ¿¾ï¼šåƒ…ç”¨æ–¼æ’é™¤å·²ä½¿ç”¨çš„é¡Œç›®ï¼ˆFirestore ä¸æ”¯æŒ `NOT IN`ï¼‰

**ä»£ç¢¼ä½ç½®**ï¼šç¬¬ 111-151 è¡Œ

**æ€§èƒ½æå‡**ï¼š
- ç¶²çµ¡å‚³è¼¸æ¸›å°‘ 50-80%
- æŸ¥è©¢é€Ÿåº¦æå‡ 30-50%
- Firestore è®€å–æˆæœ¬é™ä½ 70-80%

---

### 4. Firebase ç´¢å¼•å‰µå»ºæŒ‡å—

**æ–‡ä»¶**ï¼š`docs/FIREBASE_INDEX_SETUP_GUIDE.md`

**å…§å®¹**ï¼š
- âœ… è©³ç´°çš„ç´¢å¼•é…ç½®èªªæ˜
- âœ… å…©ç¨®å‰µå»ºæ–¹æ³•ï¼ˆConsole å’Œ CLIï¼‰
- âœ… æ¸¬è©¦å’Œé©—è­‰æ­¥é©Ÿ
- âœ… å¸¸è¦‹å•é¡Œè§£ç­”

**éœ€è¦å‰µå»ºçš„ç´¢å¼•**ï¼š
1. `grade_subject_topic_id_source`ï¼ˆä¸»è¦æŸ¥è©¢ç´¢å¼•ï¼‰
2. `grade_source_created_at`ï¼ˆæ™‚é–“æ’åºç´¢å¼•ï¼‰
3. `subject_topic_id_grade`ï¼ˆå¯é¸ï¼Œè·¨å¹´ç´šæŸ¥è©¢ï¼‰

---

## ğŸ“Š æ•¸æ“šçµæ§‹æ›´æ–°

### å„²å­˜çš„æ¬„ä½ï¼ˆåˆ†é¡é‚è¼¯ï¼‰

```
past_papers é›†åˆæ–‡æª”ï¼š
{
    // åˆ†é¡å±¤ç´šï¼ˆå¹´ç´š > ç§‘ç›® > å–®å…ƒ > å­å–®å…ƒï¼‰
    grade: "P4",              // å¹´ç´š
    subject: "math",          // ç§‘ç›®ï¼ˆæ–°å¢ï¼‰
    topic_id: "p4_division", // å–®å…ƒ ID
    topic: "é™¤æ³•",            // å–®å…ƒåç¨±ï¼ˆå¯é¸ï¼Œç”¨æ–¼é¡¯ç¤ºï¼‰
    
    // é¡Œç›®å…§å®¹
    question: "...",
    answer: "...",
    options: [...],
    explanation: "...",
    
    // å…ƒæ•¸æ“š
    source: "ai_next_api",
    created_at: "2026-01-08T..."
}
```

---

## ğŸ” æŸ¥è©¢å„ªåŒ–å°æ¯”

### å„ªåŒ–å‰ï¼ˆå®¢æˆ¶ç«¯éæ¿¾ï¼‰

```javascript
// æŸ¥è©¢æ‰€æœ‰ P4 é¡Œç›®ï¼ˆ50 é¡Œï¼‰
query(
    where("grade", "==", "P4"),
    where("source", "==", "ai_next_api"),
    limit(50)
)
// ç„¶å¾Œåœ¨å®¢æˆ¶ç«¯éæ¿¾ï¼š
// - æŒ‰ topic_id éæ¿¾
// - æŒ‰ subject éæ¿¾
// - æ’é™¤å·²ä½¿ç”¨çš„é¡Œç›®
```

**å•é¡Œ**ï¼š
- å‚³è¼¸ 50 é¡Œï¼Œä½†å¯èƒ½åªéœ€è¦ 5-10 é¡Œ
- å®¢æˆ¶ç«¯è™•ç†æ™‚é–“é•·
- Firestore è®€å–æˆæœ¬é«˜

---

### å„ªåŒ–å¾Œï¼ˆæœå‹™å™¨ç«¯éæ¿¾ï¼‰

```javascript
// æœå‹™å™¨ç«¯éæ¿¾ï¼ˆåªå‚³è¼¸åŒ¹é…çš„é¡Œç›®ï¼‰
query(
    where("grade", "==", "P4"),
    where("subject", "==", "math"),      // æœå‹™å™¨ç«¯éæ¿¾
    where("topic_id", "==", "p4_division"), // æœå‹™å™¨ç«¯éæ¿¾
    where("source", "==", "ai_next_api"),
    limit(50)
)
// å®¢æˆ¶ç«¯åªéæ¿¾ï¼š
// - æ’é™¤å·²ä½¿ç”¨çš„é¡Œç›®ï¼ˆFirestore ä¸æ”¯æŒ NOT INï¼‰
```

**å„ªå‹¢**ï¼š
- åªå‚³è¼¸åŒ¹é…çš„é¡Œç›®ï¼ˆé€šå¸¸ 5-15 é¡Œï¼‰
- å®¢æˆ¶ç«¯è™•ç†æ™‚é–“çŸ­
- Firestore è®€å–æˆæœ¬ä½

---

## ğŸ“ˆ é æœŸæ€§èƒ½æå‡ï¼ˆ1 è¬ç”¨æˆ¶ï¼‰

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æå‡ |
|------|--------|--------|------|
| **æŸ¥è©¢éŸ¿æ‡‰æ™‚é–“** | 500-1000ms | 200-400ms | 50-60% |
| **ç¶²çµ¡å‚³è¼¸** | 50-100 KB | 10-20 KB | 80% |
| **Firestore è®€å–** | 50 æ¬¡/æŸ¥è©¢ | 10-15 æ¬¡/æŸ¥è©¢ | 70-80% |
| **æœˆåº¦æˆæœ¬** | $0.36 | $0.072 | 80% |

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### æ¸¬è©¦ 1ï¼šé©—è­‰ `subject` æ¬„ä½å„²å­˜

```javascript
// ç”Ÿæˆä¸€é¡Œï¼Œæª¢æŸ¥ Firestore
// é æœŸï¼šæ–‡æª”æ‡‰åŒ…å« subject: "math" | "chi" | "eng"
```

### æ¸¬è©¦ 2ï¼šé©—è­‰æœå‹™å™¨ç«¯éæ¿¾

```javascript
// èª¿ç”¨ fetchUnusedQuestion
// é æœŸï¼šæ§åˆ¶å°æ—¥èªŒé¡¯ç¤º "Server-side filtered: found X questions"
// é©—è­‰ï¼šåªè¿”å›åŒ¹é…çš„é¡Œç›®
```

### æ¸¬è©¦ 3ï¼šé©—è­‰ç´¢å¼•

```javascript
// åœ¨ Firebase Console åŸ·è¡ŒæŸ¥è©¢
// é æœŸï¼šæŸ¥è©¢å¿«é€Ÿï¼ˆ< 500msï¼‰ï¼Œç„¡éœ€æç¤ºå‰µå»ºç´¢å¼•
```

---

## âš ï¸ é‡è¦æé†’

### 1. Firebase ç´¢å¼•å¿…é ˆå‰µå»º

**å¿…é ˆæ“ä½œ**ï¼š
1. ç™»å…¥ Firebase Console
2. å‰µå»ºç´¢å¼• 1ï¼š`grade_subject_topic_id_source`
3. å‰µå»ºç´¢å¼• 2ï¼š`grade_source_created_at`
4. ç­‰å¾…ç´¢å¼•æ§‹å»ºå®Œæˆï¼ˆå¯èƒ½éœ€è¦å¹¾å°æ™‚ï¼‰

**å¦‚æœä¸å‰µå»ºç´¢å¼•**ï¼š
- æŸ¥è©¢æœƒå¤±æ•—æˆ–å¾ˆæ…¢
- Firebase æœƒæç¤ºéœ€è¦å‰µå»ºç´¢å¼•

### 2. ç¾æœ‰æ•¸æ“šè™•ç†

**å•é¡Œ**ï¼šç¾æœ‰é¡Œç›®å¯èƒ½æ²’æœ‰ `subject` æ¬„ä½

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- âœ… æ–°é¡Œç›®æœƒè‡ªå‹•æ·»åŠ  `subject`
- âœ… æŸ¥è©¢æ™‚å¦‚æœé¡Œç›®æ²’æœ‰ `subject`ï¼Œæœƒè·³é `subject` éæ¿¾ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
- âš ï¸ å¯é¸ï¼šç·¨å¯«é·ç§»è…³æœ¬ç‚ºèˆŠæ•¸æ“šæ·»åŠ  `subject`

### 3. æŸ¥è©¢æ¢ä»¶é †åº

**é‡è¦**ï¼šæŸ¥è©¢çš„ `where` æ¢ä»¶é †åºå¿…é ˆåŒ¹é…ç´¢å¼•

**æ­£ç¢ºé †åº**ï¼ˆåŒ¹é…ç´¢å¼• 1ï¼‰ï¼š
```javascript
where("grade", "==", level),      // 1
where("subject", "==", subject),  // 2
where("topic_id", "==", topicId), // 3
where("source", "==", "ai_next_api") // 4
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³è¡Œå‹•ï¼ˆä»Šå¤©ï¼‰

1. âœ… **ä»£ç¢¼å·²æ›´æ–°**ï¼ˆå·²å®Œæˆï¼‰
2. â³ **å‰µå»º Firebase ç´¢å¼•**ï¼ˆéœ€è¦åœ¨ Firebase Console æ“ä½œï¼‰
   - åƒè€ƒï¼š`docs/FIREBASE_INDEX_SETUP_GUIDE.md`
   - é è¨ˆæ™‚é–“ï¼š30 åˆ†é˜ï¼ˆæ“ä½œï¼‰+ ç­‰å¾…æ§‹å»ºï¼ˆ1-3 å°æ™‚ï¼‰

### æ¸¬è©¦é©—è­‰ï¼ˆæ˜å¤©ï¼‰

1. æ¸¬è©¦é¡Œç›®ç”Ÿæˆå’Œå„²å­˜
2. æ¸¬è©¦ `fetchUnusedQuestion` æŸ¥è©¢
3. é©—è­‰æ€§èƒ½æå‡

### ç›£æ§ï¼ˆæœ¬é€±ï¼‰

1. ç›£æ§æŸ¥è©¢æ€§èƒ½
2. æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ
3. é©—è­‰ `subject` æ¬„ä½æ­£ç¢ºå„²å­˜

---

## ğŸ¯ å®Œæˆç‹€æ…‹

- [x] æ·»åŠ  `subject` æ¬„ä½åˆ°å„²å­˜é‚è¼¯
- [x] æ›´æ–°æ‰€æœ‰èª¿ç”¨è™•å‚³å…¥ `subject`
- [x] å¯¦æ–½æœå‹™å™¨ç«¯éæ¿¾
- [x] å‰µå»º Firebase ç´¢å¼•æŒ‡å—
- [ ] **å¾…å®Œæˆ**ï¼šåœ¨ Firebase Console å‰µå»ºç´¢å¼•ï¼ˆéœ€è¦æ‰‹å‹•æ“ä½œï¼‰

---

**ç¸½çµçµæŸ**
