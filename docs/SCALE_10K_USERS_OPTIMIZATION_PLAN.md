# 1 萬用戶規模優化計劃

> **目標規模**：10,000 用戶  
> **制定日期**：2026-01-08  
> **目的**：為 1 萬用戶規模提前優化系統性能、成本和可擴展性

---

## 📊 規模分析

### 1 萬用戶的預期數據量

#### 題目庫規模（假設）
- **每個年級**：6 個年級（P1-P6）
- **每個年級每科**：約 10-15 個主題
- **每個主題**：平均 50-100 題（AI 生成）
- **總題目數**：約 **15,000 - 27,000 題**

#### 用戶使用記錄規模
- **活躍用戶**（30%）：3,000 人
- **平均每人做過**：200 題
- **總使用記錄**：約 **600,000 條**
- **重度用戶**（10%）：1,000 人，每人 > 500 題

#### 查詢負載估算
- **日活躍用戶**（20%）：2,000 人
- **每人每天**：10 次查詢（練習 10 題）
- **每日查詢次數**：約 **20,000 次**
- **每月查詢次數**：約 **600,000 次**

---

## 🎯 優化優先級（針對 1 萬用戶）

### 🔴 高優先級（必須立即實施）

#### 1. 服務器端過濾 ⭐⭐⭐

**為什麼必須做**：
- 1 萬用戶規模下，每次查詢浪費的帶寬和成本會累積
- 客戶端過濾 50 題 × 20,000 次/天 = 大量不必要的數據傳輸

**預期效果**：
- 減少 50-80% 的網絡傳輸
- 降低 Firestore 讀取成本 50-80%
- 提升查詢速度 30-50%

**實施時間**：✅ **立即實施**（1-2 小時）

---

#### 2. 添加 `subject` 欄位 ⭐⭐⭐

**為什麼必須做**：
- 沒有 `subject` 欄位，無法高效查詢「數學題目」
- 客戶端過濾會導致性能問題

**實施步驟**：
1. 修改 `saveGeneratedQuestion` 接受 `subject` 參數
2. 更新 `ai-service.js` 所有調用處
3. 為現有數據添加 `subject`（可選，向後兼容）

**實施時間**：✅ **立即實施**（2-3 小時）

---

#### 3. Firebase 複合索引 ⭐⭐⭐

**為什麼必須做**：
- 1 萬用戶規模下，沒有索引的查詢會很慢
- 複合查詢（grade + subject + topic_id）需要索引

**需要創建的索引**：
```
索引 1：grade_subject_topic_id_source
- grade (ASC)
- subject (ASC)
- topic_id (ASC)
- source (ASC)

索引 2：grade_source_created_at
- grade (ASC)
- source (ASC)
- created_at (DESC)
```

**實施時間**：✅ **立即實施**（30 分鐘，在 Firebase Console 操作）

---

### 🟡 中優先級（1-2 週內實施）

#### 4. 動態限制機制 ⭐⭐

**為什麼需要做**：
- 1 萬用戶中，會有重度用戶（已做過 500+ 題）
- 固定 50 題限制可能不夠用

**實施策略**：
- 初始限制：50 題
- 如果找不到，增加到 100 題
- 如果還不夠，增加到 200 題
- 最大限制：500 題

**實施時間**：✅ **1-2 週內實施**（2-4 小時）

---

#### 5. 使用記錄查詢優化 ⭐⭐

**為什麼需要做**：
- 重度用戶的使用記錄可能 > 1000 條
- 每次查詢都獲取所有記錄會很慢

**優化策略**：
- 只查詢最近 6 個月的記錄（假設用戶不會重複做 6 個月前的題目）
- 或使用分頁查詢（每次查詢 100 條）

**實施時間**：✅ **2-3 週內實施**（3-5 小時）

---

### 🟢 低優先級（1-2 個月內實施）

#### 6. 客戶端緩存機制 ⭐

**為什麼考慮做**：
- 減少重複查詢使用記錄
- 提升用戶體驗（更快載入）

**實施策略**：
- 使用 `localStorage` 緩存用戶的使用記錄 ID
- 緩存時間：5-10 分鐘
- 緩存失效：用戶答題後更新

**實施時間**：⏳ **1-2 個月內實施**（4-6 小時）

---

#### 7. 分頁查詢機制 ⭐

**為什麼考慮做**：
- 如果題目庫增長到 > 10,000 題
- 需要支持更高效的查詢

**實施時間**：⏳ **等題目庫 > 10,000 題時實施**（1-2 天）

---

## 📅 實施時間表

### 第 1 週（立即）

**Day 1-2**：
- ✅ 添加 `subject` 欄位到儲存邏輯
- ✅ 修改 `saveGeneratedQuestion` 函數
- ✅ 更新所有調用處

**Day 3**：
- ✅ 實施服務器端過濾
- ✅ 修改 `fetchUnusedQuestion` 查詢條件

**Day 4**：
- ✅ 在 Firebase Console 創建複合索引
- ✅ 測試驗證

**Day 5-7**：
- ✅ 監控和調試
- ✅ 性能測試

---

### 第 2-3 週

**Week 2**：
- ✅ 實施動態限制機制
- ✅ 添加配置常量
- ✅ 測試各種場景

**Week 3**：
- ✅ 優化使用記錄查詢
- ✅ 添加時間範圍過濾
- ✅ 性能測試

---

### 第 2 個月

**Month 2**：
- ⏳ 評估是否需要客戶端緩存
- ⏳ 評估是否需要分頁查詢
- ⏳ 根據實際使用情況決定

---

## 💰 成本估算（1 萬用戶）

### Firestore 讀取成本

**當前策略**（固定 50 題，客戶端過濾）：
- 每日查詢：20,000 次
- 每次查詢：50 次讀取
- 每日讀取：1,000,000 次
- **月度成本**：約 **$0.36**（1M × 30 天 × $0.0000006/讀取）

**優化後**（服務器端過濾，平均 10 題匹配）：
- 每日查詢：20,000 次
- 每次查詢：10 次讀取（假設過濾後只剩 10 題）
- 每日讀取：200,000 次
- **月度成本**：約 **$0.072**（節省 80%）

**年度節省**：約 **$3.46**

---

### 網絡帶寬成本

**當前策略**：
- 每題約 1-2 KB
- 50 題 × 20,000 次 = 1,000,000 KB = 1 GB/天
- **月度帶寬**：約 30 GB

**優化後**：
- 10 題 × 20,000 次 = 200,000 KB = 0.2 GB/天
- **月度帶寬**：約 6 GB（節省 80%）

---

## 🎯 性能目標（1 萬用戶）

### 查詢性能目標

| 指標 | 當前 | 目標 | 優化後 |
|------|------|------|--------|
| `fetchUnusedQuestion` 響應時間 | 500-1000ms | < 300ms | 200-400ms |
| 網絡傳輸大小 | 50-100 KB | < 20 KB | 10-20 KB |
| Firestore 讀取次數 | 50 次/查詢 | < 15 次/查詢 | 10-15 次/查詢 |

### 用戶體驗目標

- **題目載入時間**：< 500ms（P95）
- **「找不到題目」錯誤率**：< 1%
- **查詢成功率**：> 99%

---

## 🔧 實施檢查清單

### 第 1 週任務

- [ ] **Day 1-2**：添加 `subject` 欄位
  - [ ] 修改 `saveGeneratedQuestion` 函數簽名
  - [ ] 更新 `ai-service.js` 所有調用處（約 3-4 處）
  - [ ] 測試驗證

- [ ] **Day 3**：實施服務器端過濾
  - [ ] 修改 `fetchUnusedQuestion` 查詢條件
  - [ ] 添加 `where("topic_id", "==", topicId)`（如果提供）
  - [ ] 添加 `where("subject", "==", subject)`（如果提供）
  - [ ] 測試驗證

- [ ] **Day 4**：創建 Firebase 索引
  - [ ] 登入 Firebase Console
  - [ ] 創建 `grade_subject_topic_id_source` 索引
  - [ ] 創建 `grade_source_created_at` 索引
  - [ ] 等待索引構建完成（可能需要幾小時）

- [ ] **Day 5-7**：監控和測試
  - [ ] 性能測試
  - [ ] 功能測試
  - [ ] 監控日誌

### 第 2-3 週任務

- [ ] **Week 2**：動態限制機制
  - [ ] 添加配置常量
  - [ ] 實現重試邏輯
  - [ ] 測試各種場景

- [ ] **Week 3**：使用記錄查詢優化
  - [ ] 添加時間範圍過濾
  - [ ] 實現分頁查詢（如果需要）
  - [ ] 性能測試

---

## 📈 監控指標（1 萬用戶）

### 關鍵指標

1. **查詢性能**
   - `fetchUnusedQuestion` 平均響應時間
   - P95 響應時間
   - 查詢失敗率

2. **數據規模**
   - `past_papers` 集合文檔數量（按年級、主題統計）
   - 用戶使用記錄數量（按用戶統計）
   - 平均每個用戶已做過的題目數

3. **成本指標**
   - Firestore 每日讀取次數
   - 月度 Firestore 成本
   - 網絡帶寬使用量

4. **用戶體驗**
   - 「找不到題目」錯誤次數
   - 題目載入時間
   - 用戶投訴數量

### 監控頻率

- **每日**：檢查錯誤日誌和性能指標
- **每週**：統計數據規模和成本
- **每月**：全面評估和優化

---

## 🚨 風險與應對

### 風險 1：索引構建時間長

**問題**：Firebase 複合索引可能需要幾小時才能構建完成

**應對**：
- 提前創建索引（在用戶增長前）
- 使用臨時查詢策略（如果索引未完成）

### 風險 2：現有數據缺少 `subject` 欄位

**問題**：舊題目沒有 `subject` 欄位，查詢可能失敗

**應對**：
- 實現向後兼容邏輯（查詢時如果沒有 `subject`，從 `topic_id` 推斷）
- 可選：編寫遷移腳本為舊數據添加 `subject`

### 風險 3：用戶使用記錄查詢變慢

**問題**：重度用戶的使用記錄 > 1000 條，查詢變慢

**應對**：
- 實施時間範圍過濾（只查詢最近 6 個月）
- 實施分頁查詢
- 考慮客戶端緩存

---

## 💡 最佳實踐建議

### 1. 漸進式優化

不要一次性實施所有優化，而是：
1. 先實施高優先級項目（第 1 週）
2. 監控 1-2 週
3. 根據實際情況決定是否需要中優先級項目

### 2. 性能測試

在實施每個優化後：
- 進行性能測試
- 對比優化前後的指標
- 驗證功能正確性

### 3. 監控和告警

設置監控：
- 查詢響應時間告警（> 1 秒）
- 錯誤率告警（> 5%）
- 成本告警（月度成本 > $10）

### 4. 文檔更新

每次優化後：
- 更新技術文檔
- 記錄性能改進數據
- 更新運維手冊

---

## 📝 總結

針對 **1 萬用戶規模**，建議的實施計劃：

### 立即實施（第 1 週）
1. ✅ 添加 `subject` 欄位
2. ✅ 實施服務器端過濾
3. ✅ 創建 Firebase 複合索引

### 短期實施（第 2-3 週）
4. ✅ 實施動態限制機制
5. ✅ 優化使用記錄查詢

### 長期考慮（第 2 個月）
6. ⏳ 評估客戶端緩存
7. ⏳ 評估分頁查詢

**預期效果**：
- 查詢速度提升 50-70%
- 成本降低 60-80%
- 用戶體驗顯著改善

---

**報告結束**
