# 第 1 週優化完成檢查清單

> **完成日期**：2026-01-08  
> **目標**：為 1 萬用戶規模優化查詢性能

---

## ✅ 已完成項目

### 代碼層面

- [x] **添加 `subject` 欄位到儲存邏輯**
  - 文件：`app/lib/rag-service.js`
  - 狀態：✅ 已完成

- [x] **更新所有調用處傳入 `subject`**
  - 文件：`app/lib/ai-service.js`
  - 狀態：✅ 已完成（3 處調用）

- [x] **實施服務器端過濾**
  - 文件：`app/lib/rag-service.js`
  - 狀態：✅ 已完成

- [x] **創建 Firebase 索引**
  - 索引 1：`grade_subject_topic_id_source` ✅
  - 索引 2：`grade_source_created_at` ✅
  - 狀態：✅ 已完成

---

## 🧪 驗證步驟

### 步驟 1：驗證索引狀態

1. 在 Firebase Console 的「索引」標籤頁檢查：
   - [ ] 索引 1 狀態為「已啟用」（不是「構建中」）
   - [ ] 索引 2 狀態為「已啟用」（不是「構建中」）

**如果狀態是「構建中」**：
- 等待 1-3 小時（取決於數據量）
- 可以繼續測試，但查詢可能較慢

---

### 步驟 2：測試題目生成和儲存

1. **啟動應用**：
   ```bash
   npm run dev
   ```

2. **生成一題**：
   - 登入系統
   - 選擇一個單元（例如：P4 數學 - 除法）
   - 生成一題

3. **檢查 Firestore**：
   - 打開 Firebase Console → Firestore Database
   - 導航到 `artifacts/default-app-id/public/data/past_papers`
   - 找到最新創建的文檔
   - 驗證包含以下欄位：
     - [ ] `grade`: "P4"
     - [ ] `subject`: "math"（新增欄位）
     - [ ] `topic_id`: "p4_division"
     - [ ] `source`: "ai_next_api"

**預期結果**：新題目應該包含 `subject` 欄位

---

### 步驟 3：測試服務器端過濾

1. **檢查控制台日誌**：
   - 打開瀏覽器開發者工具（F12）
   - 切換到 Console 標籤
   - 生成題目時，應該看到：
     ```
     📊 Server-side filtered: found X questions (grade=P4, subject=math, topic=p4_division)
     ```

2. **驗證查詢性能**：
   - 觀察查詢時間（應該 < 500ms）
   - 檢查網絡請求大小（應該 < 20 KB）

**預期結果**：
- 控制台顯示「Server-side filtered」
- 查詢速度快
- 網絡傳輸小

---

### 步驟 4：測試使用記錄

1. **答題測試**：
   - 回答一題
   - 檢查控制台日誌：
     ```
     ✅ Usage recorded for Question ID: xxx, isCorrect: true/false
     ```

2. **檢查 Firestore**：
   - 導航到 `artifacts/default-app-id/users/{your-uid}/question_usage`
   - 應該看到新創建的使用記錄文檔

**預期結果**：使用記錄正確儲存

---

## 📊 性能監控

### 關鍵指標

監控以下指標，確認優化效果：

1. **查詢響應時間**
   - 目標：< 500ms
   - 監控位置：瀏覽器 Console 或 Network 標籤

2. **網絡傳輸大小**
   - 目標：< 20 KB（優化前：50-100 KB）
   - 監控位置：瀏覽器 Network 標籤

3. **Firestore 讀取次數**
   - 目標：10-15 次/查詢（優化前：50 次）
   - 監控位置：Firebase Console → Firestore → 使用情況

---

## ⚠️ 常見問題排查

### 問題 1：查詢仍然很慢

**可能原因**：
- 索引還在構建中
- 查詢條件順序不匹配索引

**解決方案**：
1. 檢查索引狀態（應該是「已啟用」）
2. 檢查查詢代碼中的 `where` 條件順序

### 問題 2：查詢失敗，提示需要索引

**可能原因**：
- 索引未創建
- 索引欄位配置錯誤

**解決方案**：
1. 檢查索引是否已創建
2. 檢查欄位名稱是否正確（區分大小寫）
3. 檢查欄位順序是否匹配

### 問題 3：新題目沒有 `subject` 欄位

**可能原因**：
- 代碼未正確更新
- `allTopicsList` 未傳入

**解決方案**：
1. 檢查控制台是否有錯誤日誌
2. 檢查 `saveGeneratedQuestion` 調用是否傳入 `subject` 和 `allTopicsList`

---

## 🎯 優化效果驗證

### 對比測試

**測試場景**：生成 10 題，記錄平均查詢時間

| 指標 | 優化前 | 優化後 | 改善 |
|------|--------|--------|------|
| 平均查詢時間 | ? | ? | ? |
| 平均網絡傳輸 | ? | ? | ? |
| 平均 Firestore 讀取 | ? | ? | ? |

**測試方法**：
1. 記錄優化前的數據（如果有的話）
2. 記錄優化後的數據
3. 對比改善情況

---

## 📝 後續建議

### 本週內

1. **監控性能**：每天檢查查詢性能指標
2. **收集反饋**：觀察用戶是否有「載入慢」的投訴
3. **檢查日誌**：確認沒有錯誤或警告

### 下週

1. **評估是否需要動態限制**：
   - 如果出現「找不到題目」的情況
   - 如果查詢時間仍然 > 1 秒

2. **考慮使用記錄查詢優化**：
   - 如果用戶使用記錄 > 1000 條
   - 如果查詢使用記錄變慢

---

## ✅ 完成確認

- [x] 代碼更新完成
- [x] Firebase 索引創建完成
- [ ] 索引狀態為「已啟用」（等待構建完成）
- [ ] 測試題目生成和儲存
- [ ] 測試服務器端過濾
- [ ] 測試使用記錄
- [ ] 性能監控確認

---

**檢查清單結束**
