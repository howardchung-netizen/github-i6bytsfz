# 查詢優化改進時機決策指南

> **目的**：幫助判斷何時實施 `fetchUnusedQuestion` 的優化改進  
> **當前狀態**：使用固定限制 50 題 + 客戶端過濾策略

---

## 📊 改進優先級與時機

### 🔴 短期：服務器端過濾（立即實施）

**實施時機**：✅ **現在就可以做**

**理由**：
1. **代碼改動小**：只需修改查詢條件，風險低
2. **立即見效**：減少網絡傳輸和客戶端處理時間
3. **無需等待**：不依賴數據積累或用戶增長
4. **成本效益高**：改動小，收益明顯

**觸發條件**：
- ✅ 代碼已經寫好（只需啟用）
- ✅ 不影響現有功能
- ✅ 可以立即提升性能

**實施步驟**：
1. 確保 `subject` 欄位已添加到儲存邏輯（參考 FIREBASE_ASSET_ANALYSIS.md）
2. 修改 `fetchUnusedQuestion` 查詢，添加 `where("topic_id", "==", topicId)` 和 `where("subject", "==", subject)`
3. 測試驗證

**預期效果**：
- 網絡傳輸減少 50-80%（只傳輸匹配的題目）
- 查詢速度提升 30-50%
- Firestore 讀取成本降低

---

### 🟡 中期：動態限制（按需實施）

**實施時機**：⚠️ **當出現以下情況時實施**

#### 觸發條件 1：用戶反饋「找不到題目」

**監控指標**：
- 控制台日誌：`⚠️ No unused questions found` 出現頻率
- 用戶投訴：「系統說沒有題目了」

**判斷標準**：
- 如果**每週出現 3 次以上**「找不到題目」的情況
- 或**有用戶明確反饋**「題目重複」或「沒有新題目」

**實施時機**：✅ **立即實施**

---

#### 觸發條件 2：題目庫規模增長

**監控指標**：
- Firestore Console：查看 `past_papers` 集合的文檔數量
- 按年級統計：每個年級有多少題目

**判斷標準**：
- **P4 數學**：題目數量 > 200 題
- **任何年級**：總題目數 > 1000 題
- **單一主題**（如「除法」）：題目數 > 50 題

**實施時機**：✅ **達到標準後 1-2 週內實施**

---

#### 觸發條件 3：用戶使用記錄累積

**監控指標**：
- 檢查活躍用戶的使用記錄數量
- 統計：平均每個用戶已做過多少題

**判斷標準**：
- **活躍用戶**（每週使用 3 次以上）：平均已做過 > 100 題
- **重度用戶**（每天使用）：已做過 > 500 題

**實施時機**：✅ **當 10% 的活躍用戶達到標準時實施**

---

#### 觸發條件 4：性能問題出現

**監控指標**：
- 查詢響應時間：`fetchUnusedQuestion` 執行時間
- 用戶體驗：題目載入時間

**判斷標準**：
- 查詢時間 > 2 秒（超過 3 次）
- 用戶反饋「載入慢」

**實施時機**：✅ **立即實施**

---

### 🟢 長期：分頁查詢和緩存（未來優化）

**實施時機**：⏳ **當系統達到一定規模時**

#### 觸發條件 1：用戶基數增長

**監控指標**：
- 日活躍用戶數（DAU）
- 月活躍用戶數（MAU）

**判斷標準**：
- **DAU > 100** 或 **MAU > 1000**
- 同時**用戶反饋性能問題**

**實施時機**：✅ **達到標準後 1 個月內實施**

---

#### 觸發條件 2：使用記錄大量累積

**監控指標**：
- 單個用戶的使用記錄數量
- 查詢使用記錄的響應時間

**判斷標準**：
- **單個用戶**：使用記錄 > 2000 條
- **查詢時間**：獲取使用記錄 > 1 秒

**實施時機**：✅ **當 5% 的用戶達到標準時實施**

---

#### 觸發條件 3：Firestore 成本上升

**監控指標**：
- Firebase Console：Firestore 讀取次數
- 月度成本報告

**判斷標準**：
- **月度讀取次數**：> 100,000 次
- **月度成本**：> $10（僅 Firestore 讀取）

**實施時機**：✅ **成本持續上升時實施**

---

## 🎯 決策流程圖

```
開始
  ↓
檢查：是否有 subject 欄位？
  ↓ 否 → 先實施「添加 subject 欄位」（FIREBASE_ASSET_ANALYSIS.md 階段 1）
  ↓ 是
  ↓
【短期改進】服務器端過濾
  ↓ 立即實施（代碼改動小，風險低）
  ↓
監控 1-2 週
  ↓
檢查：是否出現「找不到題目」？
  ↓ 是 → 【中期改進】動態限制
  ↓ 否
  ↓
檢查：題目庫規模 > 200 題/年級？
  ↓ 是 → 【中期改進】動態限制
  ↓ 否
  ↓
檢查：活躍用戶平均已做過 > 100 題？
  ↓ 是 → 【中期改進】動態限制
  ↓ 否
  ↓
繼續監控...
  ↓
檢查：DAU > 100 或使用記錄查詢 > 1 秒？
  ↓ 是 → 【長期改進】分頁和緩存
  ↓ 否
  ↓
保持現狀
```

---

## 📈 監控建議

### 1. 添加日誌監控

在 `fetchUnusedQuestion` 中添加統計日誌：

```javascript
// 記錄查詢統計
console.log(`📊 Query Stats: 
  - Total questions queried: ${questionsSnap.size}
  - After topic filter: ${afterTopicFilter}
  - After subject filter: ${afterSubjectFilter}
  - After usage filter: ${candidateQuestions.length}
  - User has attempted: ${usedQuestionIds.size} questions`);
```

### 2. 定期檢查 Firestore Console

**每週檢查**：
- `past_papers` 集合的文檔數量
- 按 `grade` 分組統計
- 按 `topic_id` 分組統計

**每月檢查**：
- 用戶使用記錄增長趨勢
- Firestore 讀取次數趨勢
- 成本變化

### 3. 用戶反饋收集

**監控渠道**：
- 應用內錯誤報告
- 用戶支持郵件
- 應用商店評論

**關鍵詞**：
- "找不到題目"
- "題目重複"
- "載入慢"
- "沒有新題目"

---

## ⚡ 快速決策表

| 情況 | 短期改進 | 中期改進 | 長期改進 |
|------|---------|---------|---------|
| **剛上線，用戶 < 10** | ✅ 立即 | ❌ 不需要 | ❌ 不需要 |
| **用戶 10-50，題目 < 100** | ✅ 立即 | ⚠️ 監控 | ❌ 不需要 |
| **用戶 50-200，題目 100-500** | ✅ 已完成 | ✅ 考慮實施 | ❌ 不需要 |
| **用戶 > 200，題目 > 500** | ✅ 已完成 | ✅ 應該實施 | ⚠️ 開始規劃 |
| **出現性能問題** | ✅ 已完成 | ✅ 立即實施 | ✅ 考慮實施 |
| **用戶反饋「找不到題目」** | ✅ 已完成 | ✅ 立即實施 | ⚠️ 評估需求 |

---

## 🔧 實施檢查清單

### 短期改進（服務器端過濾）

- [ ] 確認 `subject` 欄位已添加到儲存邏輯
- [ ] 修改 `fetchUnusedQuestion` 查詢條件
- [ ] 測試：驗證查詢結果正確
- [ ] 測試：驗證性能提升
- [ ] 部署到生產環境

**預計時間**：1-2 小時

---

### 中期改進（動態限制）

- [ ] 添加配置常量（`QUESTION_QUERY_LIMIT`）
- [ ] 實現動態限制邏輯
- [ ] 添加重試機制
- [ ] 測試：驗證各種場景（50 題不夠、100 題不夠等）
- [ ] 添加日誌監控
- [ ] 部署到生產環境

**預計時間**：2-4 小時

---

### 長期改進（分頁和緩存）

- [ ] 設計緩存策略（localStorage 或內存緩存）
- [ ] 實現分頁查詢邏輯
- [ ] 實現緩存失效機制
- [ ] 測試：驗證緩存命中率
- [ ] 測試：驗證性能提升
- [ ] 添加監控儀表板
- [ ] 部署到生產環境

**預計時間**：1-2 天

---

## 💡 建議

### 當前階段（系統剛上線）

**立即做**：
1. ✅ **短期改進**：服務器端過濾（代碼改動小，立即見效）

**暫時不做**：
2. ❌ **中期改進**：動態限制（等有實際需求時再做）
3. ❌ **長期改進**：分頁和緩存（等用戶基數增長後再做）

### 1-3 個月後（系統穩定運行）

**檢查指標**：
- 題目庫規模
- 用戶使用記錄數量
- 用戶反饋

**如果出現問題**：
- ✅ 實施中期改進（動態限制）

### 6 個月後（系統成熟）

**檢查指標**：
- 用戶基數
- 性能指標
- 成本指標

**如果達到標準**：
- ✅ 考慮長期改進（分頁和緩存）

---

## 📝 總結

**核心原則**：**按需優化，不要過早優化**

1. **短期改進**：現在就可以做（成本低，收益高）
2. **中期改進**：等出現實際問題時再做（避免過早優化）
3. **長期改進**：等系統規模達到一定水平時再做（需要更多資源）

**監控是關鍵**：定期檢查指標，根據實際情況決定何時實施改進。

---

**報告結束**
