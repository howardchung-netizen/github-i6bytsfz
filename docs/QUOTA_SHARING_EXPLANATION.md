# 配額共享機制說明

## 🔍 關鍵發現

### 問題：為什麼用 1.5 Flash 卻顯示 2.5 Flash 配額已用完？

**答案：Google Gemini API 的配額是共享的！**

---

## 📊 配額共享機制

### 重要理解

**同一個 API Key 的所有模型共享配額**

這意味著：
- 如果您使用 `gemini-2.5-flash` 用完了配額
- 即使改回使用 `gemini-1.5-flash`，配額仍然是用完的狀態
- **配額不是按模型分別計算的**

### 實際情況

1. **2天前晚上**：
   - 可能使用了 `gemini-2.5-flash` 或 `gemini-2.0-flash-exp`
   - 用完了免費層配額（RPD: 20 或 1,500，取決於模型）

2. **現在**：
   - 即使代碼改回使用 `gemini-flash-latest` (1.5 Flash)
   - 配額仍然是用完的狀態
   - 因為是同一個 API Key

---

## ⏰ 配額重置機制

### 24小時滾動窗口（最可能）

**不是日曆日重置，而是24小時滾動窗口**

例如：
- **1月6日晚上8點**：用完配額
- **重置時間**：1月7日晚上8點（24小時後）
- **不是**：1月7日午夜或下午4點

### 如何確認重置時間

1. **記錄最後一次請求時間**：
   - 查看 Google AI Studio 的使用量圖表
   - 找到最後一次成功的請求時間

2. **計算24小時後**：
   - 從最後一次請求時間開始
   - 加24小時 = 重置時間

3. **測試**：
   - 在重置時間後測試
   - 如果仍然失敗，可能是其他問題

---

## 🔧 解決方案

### 方案 1: 等待配額重置（如果還沒到24小時）

1. **確認最後一次請求時間**：
   - 前往 Google AI Studio
   - 查看使用量圖表

2. **計算重置時間**：
   - 最後一次請求時間 + 24小時

3. **在重置時間後測試**

### 方案 2: 重新生成 API Key（最快）

如果不想等待：

1. **前往 Google AI Studio**：
   - https://aistudio.google.com/app/apikey

2. **創建新的 API Key**：
   - 點擊 "Create API Key"
   - 選擇現有專案或創建新專案

3. **更新環境變數**：
   - 更新 `.env.local` 文件
   - 更新 Vercel 環境變數（如果已部署）
   - **重啟開發服務器**

4. **測試新 API Key**：
   - 新 API Key 有全新的配額
   - 應該可以立即使用

### 方案 3: 升級到付費方案

如果免費配額不夠用：

1. **前往 Google Cloud Console**：
   - https://console.cloud.google.com/

2. **設置帳單**：
   - 添加付款方式
   - 啟用付費方案

3. **獲得更高配額**：
   - 付費方案有更高的配額限制
   - 按使用量付費

---

## 📝 檢查清單

完成以下檢查：

- [ ] 確認最後一次請求的時間（Google AI Studio）
- [ ] 計算24小時後的重置時間
- [ ] 檢查當前時間是否已過重置時間
- [ ] 如果已過重置時間但仍失敗，考慮重新生成 API Key
- [ ] 確認代碼中使用的是 `gemini-flash-latest` (1.5 Flash)

---

## 💡 建議

### 短期解決方案

**重新生成 API Key**（最快）：
- 立即獲得新配額
- 不需要等待24小時
- 只需更新環境變數

### 長期解決方案

1. **監控配額使用**：
   - 記錄每次 API 調用
   - 在接近限制時提醒

2. **優化使用**：
   - 減少不必要的調用
   - 實施緩存機制

3. **考慮付費方案**：
   - 如果免費配額經常不夠用

---

## 🆘 如果問題持續

如果重新生成 API Key 後仍然有問題：

1. **檢查 Google Cloud Console**：
   - 確認專案狀態正常
   - 確認帳單設置正確

2. **聯繫 Google 支持**：
   - 如果配額重置機制異常
   - 或 API Key 有問題

---

**總結**：配額是共享的，之前使用 2.5 Flash 用完配額會影響 1.5 Flash。建議重新生成 API Key 獲得新配額。
