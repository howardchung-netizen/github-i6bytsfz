# RPM 速率限制配置指南

## 📋 概述

本應用使用 **RPM (Requests Per Minute)** 速率限制來控制 API 請求頻率，避免超過 Google Gemini API 的配額限制。

---

## ⚙️ 配置位置

**文件**：`app/lib/constants.js`

```javascript
// 測試環境：RPM 15（免費層限制）
export const RPM_LIMIT = 15;

// 正式環境：RPM 2000（付費版 2.0 Flash）
// export const RPM_LIMIT = 2000; // 正式環境：取消註釋此行並註釋上一行
```

---

## 🔄 切換到正式版步驟

### 步驟 1：更新 RPM 配置

1. 打開 `app/lib/constants.js`
2. 找到 `RPM_LIMIT` 配置
3. 修改為：

```javascript
// 測試環境：RPM 15（免費層限制）
// export const RPM_LIMIT = 15; // 註釋掉測試配置

// 正式環境：RPM 2000（付費版 2.0 Flash）
export const RPM_LIMIT = 2000; // 取消註釋
```

### 步驟 2：更新模型配置（如果需要）

如果正式版使用 `gemini-2.0-flash`：

```javascript
export const CURRENT_MODEL_NAME = "gemini-2.0-flash";
export const CURRENT_VISION_MODEL_NAME = "gemini-2.0-flash";
```

### 步驟 3：驗證配置

1. 重啟開發服務器：`npm run dev`
2. 檢查控制台輸出，應該顯示：
   ```
   🚀 API 速率限制配置：
      - RPM 限制：2000 次/分鐘
      - 最小請求間隔：33ms (0.0秒)
      ✅ 當前為正式環境配置（RPM 2000）
   ```

### 步驟 4：測試功能

1. 測試預加載功能是否正常
2. 確認速率限制是否生效
3. 檢查是否會超過 RPM 限制

---

## 📊 RPM 配置對比

| 環境 | RPM 限制 | 最小間隔 | 適用場景 |
|------|---------|---------|---------|
| **測試環境** | 15 | 4.4秒 | 免費層 API Key，開發測試 |
| **正式環境** | 2000 | 33ms | 付費版 2.0 Flash，生產環境 |

---

## 🔍 速率限制計算

### 公式

```
最小請求間隔（毫秒）= (60秒 / RPM) × 1000 × 1.1
```

### 實際計算

**測試環境（RPM 15）**：
```
間隔 = (60 / 15) × 1000 × 1.1
     = 4 × 1000 × 1.1
     = 4,400ms (4.4秒)
```

**正式環境（RPM 2000）**：
```
間隔 = (60 / 2000) × 1000 × 1.1
     = 0.03 × 1000 × 1.1
     = 33ms (0.033秒)
```

---

## ⚠️ 預加載與 RPM 的關係

### 預加載功能

**什麼是預加載（偷跑生成）？**
- 用戶做第 1 題時，背景自動生成第 2 題
- 用戶點擊「下一題」時，直接使用預加載的題目
- 實現「無感秒開下一題」的體驗

### RPM 限制的作用

**預加載不會超過 RPM 限制**：
- ✅ 預加載會遵守 `MIN_REQUEST_INTERVAL_MS` 間隔
- ✅ 如果距離上次請求不足間隔時間，會自動等待
- ✅ 確保不會超過 API 的 RPM 限制

### 實際效果

**測試環境（RPM 15）**：
- 每題間隔至少 4.4 秒
- 預加載會在間隔時間後執行
- 不會超過 15 次/分鐘的限制

**正式環境（RPM 2000）**：
- 每題間隔僅需 33ms
- 預加載幾乎無延遲
- 可以支持高頻率請求

---

## 🎯 最佳實踐

### 1. 開發階段

- ✅ 使用測試配置（RPM 15）
- ✅ 測試預加載功能
- ✅ 驗證速率限制是否生效

### 2. 部署前檢查

- ✅ 確認 RPM 配置正確
- ✅ 確認模型配置正確
- ✅ 測試預加載功能
- ✅ 檢查控制台日誌

### 3. 正式環境

- ✅ 切換到正式配置（RPM 2000）
- ✅ 更新模型為 2.0 Flash（如果需要）
- ✅ 監控 API 使用情況
- ✅ 設置配額告警

---

## 📝 檢查清單

切換到正式版前，請確認：

- [ ] `RPM_LIMIT` 已改為 2000
- [ ] 模型配置已更新（如果需要）
- [ ] 控制台顯示正確的 RPM 配置
- [ ] 預加載功能正常運作
- [ ] 速率限制生效
- [ ] 沒有超過 API 配額

---

## 🆘 常見問題

### Q1: 預加載會超過 RPM 限制嗎？

**A**: 不會。預加載會遵守 `MIN_REQUEST_INTERVAL_MS` 間隔，確保不會超過 RPM 限制。

### Q2: 如何確認 RPM 配置是否生效？

**A**: 查看瀏覽器控制台，啟動時會顯示當前 RPM 配置。

### Q3: 測試環境和正式環境可以同時運行嗎？

**A**: 可以，但需要確保使用不同的 API Key 和項目，避免配額衝突。

### Q4: 如果超過 RPM 限制會怎樣？

**A**: API 會返回 429 錯誤（Rate Limit Exceeded），應用會自動等待後重試。

---

## 📚 相關文檔

- `docs/API_QUOTA_SHARING_DETAILED.md` - 配額共享機制說明
- `docs/QUOTA_SHARING_EXPLANATION.md` - 配額共享簡要說明
- `app/lib/constants.js` - 配置文件

---

**最後更新**：2024年12月
